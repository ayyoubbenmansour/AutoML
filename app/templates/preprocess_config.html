{% extends "base.html" %}

{% block title %}Configuration du Pr√©traitement - AutoML Pro{% endblock %}

{% block extra_css %}
<style>
/* Page-specific styles for preprocessing config */
.target-display {
    background: var(--accent-gradient);
    border-radius: var(--border-radius);
    padding: 40px;
    text-align: center;
    margin-bottom: 40px;
    box-shadow: 0 15px 35px rgba(79, 172, 254, 0.3);
    position: relative;
    z-index: 3;
    animation: slideIn 0.8s ease-out 0.2s both;
}

.target-display h2 {
    margin-bottom: 20px;
    font-size: 1.8rem;
    font-weight: var(--font-weight-bold);
}

.target-name {
    font-size: 2.5rem;
    font-weight: var(--font-weight-extrabold);
    background: rgba(255, 255, 255, 0.2);
    padding: 20px 40px;
    border-radius: 50px;
    display: inline-block;
    margin: 15px 0;
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.target-display p {
    opacity: 0.95;
    font-size: 1.1rem;
    font-weight: var(--font-weight-normal);
}

.info-box {
    background: rgba(79, 172, 254, 0.15);
    border: 1px solid rgba(79, 172, 254, 0.3);
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 35px;
    backdrop-filter: blur(15px);
}

.info-box h3 {
    margin-bottom: 15px;
    color: #4facfe;
    font-size: 1.3rem;
    font-weight: var(--font-weight-bold);
}

.info-box p {
    margin: 0;
    opacity: 0.95;
    line-height: 1.6;
}

.characteristics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.characteristic-item {
    background: rgba(255, 255, 255, 0.12);
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    transition: var(--transition-smooth);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.characteristic-item.active {
    background: rgba(79, 172, 254, 0.2);
    border: 1px solid rgba(79, 172, 254, 0.4);
    transform: translateY(-5px) scale(1.03);
    box-shadow: 0 10px 25px rgba(79, 172, 254, 0.2);
}

.characteristic-item.inactive {
    opacity: 0.5;
    background: rgba(128, 128, 128, 0.1);
}

.section-indicator {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: var(--font-weight-semibold);
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 1px;
    backdrop-filter: blur(10px);
    border: 1px solid;
}

.section-indicator.required {
    background: linear-gradient(45deg, rgba(255, 107, 107, 0.2), rgba(238, 90, 82, 0.2));
    border-color: rgba(255, 107, 107, 0.5);
    color: #ff6b6b;
}

.section-indicator.optional {
    background: linear-gradient(45deg, rgba(108, 92, 231, 0.2), rgba(79, 172, 254, 0.2));
    border-color: rgba(108, 92, 231, 0.5);
    color: #4facfe;
}

.section-indicator.disabled {
    background: rgba(128, 128, 128, 0.2);
    border-color: rgba(128, 128, 128, 0.5);
    color: #999;
    opacity: 0.7;
}

.disabled-section {
    opacity: 0.6;
}

.disabled-reason {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--border-radius-small);
    padding: 20px;
    margin-top: 15px;
    font-size: 0.95rem;
    color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
}

.form-group {
    margin-bottom: 35px;
}

.form-label {
    display: block;
    font-size: 1.2rem;
    font-weight: var(--font-weight-bold);
    margin-bottom: 12px;
    color: #fff;
}

.tooltip-icon {
    display: inline-block;
    width: 22px;
    height: 22px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    text-align: center;
    line-height: 22px;
    font-size: 0.8rem;
    margin-left: 10px;
    cursor: help;
    transition: var(--transition-fast);
    position: relative;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.tooltip-icon:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.15);
}

.tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: normal;
    line-height: 1.4;
    white-space: nowrap;
    max-width: 300px;
    white-space: normal;
    width: max-content;
    max-width: 280px;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition-fast);
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    margin-bottom: 8px;
}

.tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid rgba(0, 0, 0, 0.9);
}

.tooltip-icon:hover .tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-5px);
}

.form-help {
    font-size: 0.95rem;
    opacity: 0.85;
    margin-top: 8px;
    line-height: 1.5;
    color: rgba(255, 255, 255, 0.9);
}

.submit-section {
    text-align: center;
    margin-top: 50px;
    animation: fadeInUp 0.8s ease-out 0.6s both;
}

.navigation-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 40px;
    gap: 25px;
    flex-wrap: wrap;
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .target-display .target-name {
        font-size: 1.8rem;
        padding: 15px 25px;
    }
    
    .navigation-section {
        flex-direction: column;
        text-align: center;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .characteristics-grid {
        grid-template-columns: 1fr;
    }
    
    .form-label {
        font-size: 1.1rem;
    }
    
    .tooltip {
        max-width: 250px;
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .target-display {
        padding: 25px 20px;
    }
    
    .target-display .target-name {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav class="breadcrumb">
    <ol>
        <li><a href="{{ url_for('main.home') }}">üè† Accueil</a></li>
        <li><a href="{{ url_for('main.upload') }}">üì§ Upload</a></li>
        <li><a href="{{ url_for('main.visualize') }}">üìä Visualisation</a></li>
        <li><strong>‚öôÔ∏è Pr√©traitement</strong></li>
    </ol>
</nav>

<!-- Header -->
<div class="header">
    <h1>‚öôÔ∏è Configuration du Pr√©traitement</h1>
    <p>Personnalisez le traitement de vos donn√©es pour optimiser l'entra√Ænement de votre mod√®le</p>
</div>

<!-- Target Column Display -->
<div class="target-display">
    <h2>üéØ Colonne Cible S√©lectionn√©e</h2>
    <div class="target-name">{{ target_column }}</div>
    <p>Cette colonne sera pr√©dite par votre mod√®le d'intelligence artificielle</p>
</div>

<!-- Dataset Characteristics Info -->
<div class="info-box">
    <h3>üìä Caract√©ristiques de votre dataset</h3>
    <div class="characteristics-grid">
        <div class="characteristic-item {{ 'active' if characteristics.get('has_missing_values') else 'inactive' }}">
            <strong>Valeurs manquantes</strong><br>
            {% if characteristics.get('has_missing_values') %}
                <span style="color: #ff6b6b;">‚úó {{ characteristics.get('total_missing', 0) }} d√©tect√©es</span>
            {% else %}
                <span style="color: #5951cf;">‚úì Aucune</span>
            {% endif %}
        </div>
        <div class="characteristic-item {% if characteristics.datetime_columns %}active{% else %}inactive{% endif %}">
            <strong>Variables temporelles</strong><br>
            {% if characteristics.datetime_columns %}
                <span style="color: #4facfe;">
                    {{ characteristics.datetime_columns|length }} colonne(s)
                </span>
                <div style="font-size:0.95em; margin-top:6px;">
                    <b>Datetime:</b> {{ characteristics.datetime_columns|join(', ') }}
                </div>
            {% else %}
                <span style="color: #0be453;">Aucune</span>
            {% endif %}
        </div>
        <div class="characteristic-item {{ 'active' if characteristics.get('has_categorical_columns') else 'inactive' }}">
            <strong>Variables cat√©gorielles</strong><br>
            {% if characteristics.get('has_categorical_columns') %}
                <span style="color: #4dabf7;">{{ characteristics.get('categorical_columns', [])|length }} colonnes</span>
            {% else %}
                <span style="color: #868e96;">0 colonne</span>
            {% endif %}
        </div>
        <div class="characteristic-item {{ 'active' if characteristics.get('has_numeric_columns') else 'inactive' }}">
            <strong>Variables num√©riques</strong><br>
            {% if characteristics.get('has_numeric_columns') %}
                <span style="color: #69db7c;">{{ characteristics.get('numeric_columns', [])|length }} colonnes</span>
            {% else %}
                <span style="color: #868e96;">0 colonne</span>
            {% endif %}
        </div>
        <div class="characteristic-item {{ 'active' if characteristics.get('duplicate_rows', 0) > 0 else 'inactive' }}">
            <strong>Lignes dupliqu√©es</strong><br>
            {% if characteristics.get('duplicate_rows', 0) > 0 %}
                <span style="color: #ffc107;">{{ characteristics.get('duplicate_rows', 0) }} d√©tect√©es</span>
            {% else %}
                <span style="color: #51cf66;">Aucune</span>
            {% endif %}
        </div>
    </div>
</div>
<!-- Main Form -->
<div class="glass-card">
    <form method="POST" id="preprocessForm">
        <!-- Sequence Length -->
        <div class="form-group">
            <span class="section-indicator required">Configuration RNN</span>
            <label for="sequence_length" class="form-label">
                üìè Longueur de s√©quence
                <span class="tooltip-icon">?
                    <span class="tooltip">Nombre d'observations cons√©cutives utilis√©es comme entr√©e pour les mod√®les s√©quentiels (RNN/LSTM/GRU).</span>
                </span>
            </label>
            <input type="number" name="sequence_length" id="sequence_length" class="form-control" value="10" min="1" max="100" required>
            <div class="form-help">
                Recommand√©: 10-50 pour la plupart des datasets. Des valeurs plus √©lev√©es capturent plus de patterns temporels mais augmentent la complexit√©.
            </div>
        </div>

        <div class="form-group">
            {% if characteristics.has_temporal_columns %}
                <span class="section-indicator required">Variables temporelles d√©tect√©es</span>
                <label for="temporal_handling" class="form-label">
                    üìÖ Traitement des variables temporelles
                    <span class="tooltip-icon">?
                        <span class="tooltip">Choisissez comment traiter les colonnes de type date/heure d√©tect√©es dans votre dataset.</span>
                    </span>
                </label>
                <select name="temporal_handling" id="temporal_handling" class="form-control">
                    <option value="decompose">D√©composer (ann√©e, mois, jour...)</option>
                    <option value="cyclical">Encodage cyclique</option>
                    <option value="timestamp">Timestamp num√©rique</option>
                    <option value="keep">Garder tel quel</option>
                </select>
                <div class="form-help">
                    Colonnes temporelles d√©tect√©es :
                    {% if characteristics.datetime_columns %}
                        <b>Datetime:</b> {{ characteristics.datetime_columns|join(', ') }}
                    {% endif %}
                    {% if characteristics.potential_date_columns %}
                        <b>Potentielles:</b> {{ characteristics.potential_date_columns|join(', ') }}
                    {% endif %}
                </div>
            {% else %}
                <span class="section-indicator disabled">Variables temporelles</span>
                <div class="disabled-section">
                    <label class="form-label">
                        üìÖ Traitement des variables temporelles
                    </label>
                    <div class="disabled-reason">
                        <strong>Aucune variable temporelle d√©tect√©e</strong>
                    </div>
                </div>
            {% endif %}
        </div>
        <!-- Missing Values Handling -->
        <div class="form-group">
            {% if characteristics.get('has_missing_values') %}
                <span class="section-indicator required">Valeurs manquantes d√©tect√©es</span>
                <label for="missing_handling" class="form-label">
                    üîß Gestion des valeurs manquantes
                    <span class="tooltip-icon">?
                        <span class="tooltip">M√©thode pour traiter les donn√©es manquantes dans votre jeu de donn√©es ({{ characteristics.get('total_missing', 0) }} valeurs manquantes d√©tect√©es).</span>
                    </span>
                </label>
                <select name="missing_handling" id="missing_handling" class="form-control">
                    <option value="remove">üóëÔ∏è Supprimer les lignes avec valeurs manquantes</option>
                    <option value="mean">üìä Remplacer par moyenne (num√©rique) / mode (cat√©gorique)</option>
                    <option value="median">üìà Remplacer par m√©diane (num√©rique) / mode (cat√©gorique)</option>
                </select>
            {% else %}
                <span class="section-indicator disabled">Valeurs manquantes</span>
                <div class="disabled-section">
                    <label class="form-label">
                        ‚úÖ Gestion des valeurs manquantes
                    </label>
                    <div class="disabled-reason">
                        <strong>Aucune action n√©cessaire</strong> - Votre dataset ne contient pas de valeurs manquantes ! üéâ
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Categorical Encoding -->
        <div class="form-group">
            {% if characteristics.get('has_categorical_columns') %}
                <span class="section-indicator required">Variables cat√©gorielles d√©tect√©es</span>
                <label for="encoding" class="form-label">
                    üè∑Ô∏è Encodage des variables cat√©gorielles
                    <span class="tooltip-icon">?
                        <span class="tooltip">Transformation des colonnes texte en valeurs num√©riques utilisables par les mod√®les.</span>
                    </span>
                </label>
                <select name="encoding" id="encoding" class="form-control">
                    <option value="label">üî¢ Label Encoding (attribue un entier unique √† chaque cat√©gorie)</option>
                    <option value="onehot">üìã One-Hot Encoding (cr√©e une colonne binaire pour chaque cat√©gorie)</option>
                    <option value="target">üéØ Target Encoding (encode selon la relation avec la cible)</option>
                </select>
            {% else %}
                <span class="section-indicator disabled">Variables cat√©gorielles</span>
                <div class="disabled-section">
                    <label class="form-label">
                        üìù Encodage des variables cat√©gorielles
                    </label>
                    <div class="disabled-reason">
                        <strong>Aucune action n√©cessaire</strong> - Votre dataset ne contient pas de colonnes cat√©gorielles √† encoder ! ‚ú®
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Numeric Scaling -->
        <div class="form-group">
            {% if characteristics.get('has_numeric_columns') %}
                <span class="section-indicator required">Variables num√©riques</span>
                <label for="scaling" class="form-label">
                    üìê Mise √† l'√©chelle
                    <span class="tooltip-icon">?
                        <span class="tooltip">Normalisation des valeurs num√©riques pour am√©liorer l'apprentissage du mod√®le.</span>
                    </span>
                </label>
                <select name="scaling" id="scaling" class="form-control">
                    <option value="standard">üìä Standardisation (moyenne=0, √©cart-type=1)</option>
                    <option value="minmax">üìè Min-Max Scaling (valeurs entre 0 et 1)</option>
                </select>
                <div class="form-help">
                    La standardisation est g√©n√©ralement recommand√©e pour les r√©seaux de neurones.
                </div>
            {% else %}
                <span class="section-indicator disabled">Variables num√©riques</span>
                <div class="disabled-section">
                    <label class="form-label">
                        üìä Mise √† l'√©chelle
                    </label>
                    <div class="disabled-reason">
                        <strong>Aucune colonne num√©rique d√©tect√©e</strong> - Pas de mise √† l'√©chelle n√©cessaire.
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Problem Type -->
        <div class="form-group">
            <span class="section-indicator required">Type de probl√®me</span>
            <label for="problem_type" class="form-label">
                üß† Type de probl√®me √† r√©soudre
                <span class="tooltip-icon">?
                    <span class="tooltip">Choisissez le type de t√¢che d'apprentissage supervis√© √† r√©aliser avec la colonne cible s√©lectionn√©e.</span>
                </span>
            </label>
            <select name="problem_type" id="problem_type" class="form-control" required>
                <option value="">-- Choisir --</option>
                <option value="classification">üß™ Classification (pr√©dire une classe)</option>
                <option value="regression">üìà R√©gression (pr√©dire une valeur)</option>
                <option value="forecasting">‚è≥ S√©ries temporelles (Forecasting)</option>
            </select>
            <div class="form-help">
                Le choix du type de probl√®me guide la s√©lection des mod√®les, des m√©triques et des techniques d'√©valuation.  
                Exemple : Classification pour pr√©dire une cat√©gorie, R√©gression pour une valeur continue, Forecasting pour des donn√©es temporelles.
            </div>
        </div>
        <!-- After the Problem Type select in your form -->
        <div class="form-group" id="forecasting_steps_group" style="display: none;">
            <span class="section-indicator required">Pr√©vision multi-pas</span>
            <label for="forecasting_steps" class="form-label">
                üîÆ Nombre de pas √† pr√©dire
                <span class="tooltip-icon">?
                    <span class="tooltip">Nombre d'√©tapes futures √† pr√©dire lors du forecasting (ex: 1 = un pas, 5 = cinq pas dans le futur).</span>
                </span>
            </label>
            <input type="number" name="forecasting_steps" id="forecasting_steps" class="form-control" value="1" min="1" max="100" required>
            <div class="form-help">
                Indiquez combien de pas dans le futur vous souhaitez pr√©dire (ex: 1 pour une pr√©vision √† un pas, 5 pour cinq pas).
            </div>
        </div>

        <!-- Submit Button -->
        <div class="submit-section">
            <button type="submit" class="btn btn-primary" id="submitBtn" style="padding: 18px 50px; font-size: 1.2rem;">
                ‚ú® Appliquer le pr√©traitement
            </button>
        </div>
    </form>
</div>

<!-- Navigation -->
<div class="navigation-section">
    <a href="{{ url_for('main.visualize') }}" class="btn btn-secondary">
        ‚¨ÖÔ∏è Retour √† la Visualisation
    </a>
    
    <div class="progress-indicator">
        <span class="step-badge">√âtape 3/5</span>
        <div class="progress-bar">
            <div class="progress-fill" style="width: 60%;"></div>
        </div>
    </div>
    
    <a href="{{ url_for('main.processing_mode') }}" class="btn btn-secondary">
        Mode de traitement ‚û°Ô∏è
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced tooltip functionality
document.querySelectorAll('.tooltip-icon').forEach(function(element) {
    element.addEventListener('mouseenter', function() {
        const tooltip = this.querySelector('.tooltip');
        if (tooltip) {
            tooltip.style.opacity = '1';
            tooltip.style.visibility = 'visible';
            tooltip.style.transform = 'translateX(-50%) translateY(-5px)';
        }
    });
    
    element.addEventListener('mouseleave', function() {
        const tooltip = this.querySelector('.tooltip');
        if (tooltip) {
            tooltip.style.opacity = '0';
            tooltip.style.visibility = 'hidden';
            tooltip.style.transform = 'translateX(-50%) translateY(0)';
        }
    });
});

// Enhanced form validation and submission
document.getElementById('preprocessForm').addEventListener('submit', function(e) {
    const sequenceLength = document.getElementById('sequence_length').value;
    const problemType = document.getElementById('problem_type').value;
    
    // Validate sequence length
    if (sequenceLength < 1 || sequenceLength > 100) {
        e.preventDefault();
        AutoMLUtils.showNotification('La longueur de s√©quence doit √™tre entre 1 et 100.', 'error');
        document.getElementById('sequence_length').focus();
        return false;
    }
    
    // Validate problem type
    if (!problemType) {
        e.preventDefault();
        AutoMLUtils.showNotification('Veuillez s√©lectionner un type de probl√®me.', 'error');
        document.getElementById('problem_type').focus();
        return false;
    }
    
    // Show loading state
    AutoMLUtils.showLoadingState(document.getElementById('submitBtn'), 'Traitement en cours...');
});

// Enhanced form interactions
document.querySelectorAll('.form-control').forEach(element => {
    element.addEventListener('focus', function() {
        this.parentNode.style.transform = 'translateY(-2px)';
        this.parentNode.style.transition = 'transform 0.2s ease';
    });
    
    element.addEventListener('blur', function() {
        this.parentNode.style.transform = 'translateY(0)';
    });
});

// Dynamic form validation
document.getElementById('sequence_length').addEventListener('input', function() {
    const value = parseInt(this.value);
    if (value < 1 || value > 100) {
        this.style.borderColor = '#ff6b6b';
        this.style.background = 'rgba(255, 107, 107, 0.1)';
    } else {
        this.style.borderColor = '#4facfe';
        this.style.background = 'rgba(79, 172, 254, 0.1)';
    }
});
document.getElementById('problem_type').addEventListener('change', function() {
    const group = document.getElementById('forecasting_steps_group');
    if (this.value === 'forecasting') {
        group.style.display = '';
    } else {
        group.style.display = 'none';
    }
});
</script>
{% endblock %}